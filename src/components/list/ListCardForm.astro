---
// import { getSession } from "auth-astro/server";
// import { PokeCardHandler } from "../../handlers/PokeCardHandler";
// import { PokeSetHandler } from "../../handlers/PokeSetHandler";
// import { UserListHandler } from "../../handlers/db/UserList/UserListHandler";

// Obtener el idioma de los par√°metros de la URL o usar "en" por defecto
// const { lang } = Astro.locals;
// const language = lang.toString() || "en";

// const session = await getSession(Astro.request);
// const { lists, error: listsError } = await UserListHandler.getAll({
//   userId: parseInt(session?.user?.id?.toString() || "0"),
// });

// const { sets, error } = await PokeSetHandler.getAll({ language });
// // console.log("SETS", sets);

// const { cards, error: cardsError } = await PokeCardHandler.getAll({
//   name: sets[0]?.id || "",
//   language: language,
// });
// console.log("CARDS", cards);
---

<div>
  <dialog id="dialogAddCard">
    <div class="dialog-header">
      <h2>Add Card to List</h2>
      <button
        type="button"
        onclick="closeListCardDialog()"
        class="dialog-close-btn">&times;</button
      >
    </div>

    <div id="dialogDivAddCard">
      <!-- <div id="status-message" class="hidden"></div>

      <form id="add-card-form" onsubmit="return handleSubmit(event)">
        List: <select id="dialogAddCardListId" name="listId" required>
          <option value="0">Select a list first</option>
          {
            lists?.map((list) => (
              <option value={list.id}>
                {list.name} ({list.cards?.length} cards)
              </option>
            ))
          }
        </select>
        Lang: <select
          id="lang"
          name="lang"
          required
          onchange="loadSelectSets()"
        >
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="ja">Japanese</option>
        </select>
        Set: <select
          id="dialogAddCardSetId"
          name="setId"
          onchange="loadSelectCards()"
        >
          {
            sets?.map((set) => (
              <option value={set.id}>
                {set.name} ({set.id})
              </option>
            ))
          }
        </select>
        Card: <select id="dialogAddCardCardId" name="cardId" required>
          <option value="">Select a card first</option>
          {
            cards?.map((card) => (
              <option value={card.id}>
                {card.localId ? `${card.localId} - ${card.name} ` : card.name}
              </option>
            ))
          }
        </select>

        <button type="submit" class="bg-blue-500 text-white p-2 rounded-md"
          >Add</button
        >
      </form> -->
    </div>
  </dialog>
</div>

<style>
  dialog h2 {
    margin: 0;
  }

  .hidden {
    display: none;
  }

  .success {
    background-color: #10b981;
    color: white;
    padding: 0.5rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
  }

  .error {
    background-color: #ef4444;
    color: white;
    padding: 0.5rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
  }
</style>

<script is:inline>
  let dialogAddCard = null;
  let dialogDivAddCard = null;

  document.addEventListener("astro:page-load", () => {
    console.log("DOMContentLoaded");

    dialogAddCard = document.querySelector("#dialogAddCard");
    dialogDivAddCard = document.querySelector("#dialogDivAddCard");
  });

  async function openListCardDialog(listId, cardId, cardName, lang) {
    // dialogAddCardListId.value = listId;
    // dialogAddCardCardId.value = cardId;

    await loadListCardDialog(listId, cardId, cardName, lang);

    if (dialogAddCard) dialogAddCard.showModal();
  }

  function closeListCardDialog() {
    if (dialogAddCard) dialogAddCard.close();
  }

  function loadSelectSets() {
    const dialogAddCardLang = document.querySelector("#dialogAddCardLang");
    const dialogAddCardSetId = document.querySelector("#dialogAddCardSetId");

    const currentLang = dialogAddCardLang ? dialogAddCardLang.value : "en";

    fetch(`/api/sets?lang=${currentLang}`)
      .then((response) => response.json())
      .then((data) => {
        console.log("DATA", data);
        const sets = data.sets || [];

        if (!dialogAddCardSetId) return;

        dialogAddCardSetId.innerHTML = "";
        sets.forEach((set) => {
          const option = document.createElement("option");
          option.value = set.id;
          option.textContent = `${set.name} (${set.id})`;
          dialogAddCardSetId.appendChild(option);
        });
      })
      .catch((error) => {
        console.error("Error loading sets:", error);
      });
  }

  function loadSelectCards() {
    const dialogAddCardSetId = document.querySelector("#dialogAddCardSetId");
    const dialogAddCardCardId = document.querySelector("#dialogAddCardCardId");
    const dialogAddCardCardName = document.querySelector(
      "#dialogAddCardCardName"
    );

    console.log("LOAD CARDS");
    if (!dialogAddCardSetId) return;

    const setId = dialogAddCardSetId.value;
    console.log("SET ID", setId);

    // Obtener el idioma del select o usar "en" por defecto
    const langSelect = document.querySelector('select[name="lang"]');
    const currentLang = langSelect ? langSelect.value : "en";

    fetch(`/api/cards/set/${setId}?lang=${currentLang}`)
      .then((response) => response.json())
      .then((data) => {
        console.log("DATA", data);
        const cards = data.cards || [];
        if (!dialogAddCardCardId) return;

        dialogAddCardCardId.innerHTML = "";
        cards.forEach((card) => {
          const option = document.createElement("option");
          option.value = card.id;
          option.textContent = card.localId
            ? `${card.localId} - ${card.name} `
            : card.name;
          dialogAddCardCardId.appendChild(option);
        });

        dialogAddCardCardName.value =
          dialogAddCardCardId.options.length > 0
            ? dialogAddCardCardId.options[0].dataset.name
            : "";
      })
      .catch((error) => {
        console.error("Error loading cards:", error);
      });
  }

  function selectCard() {
    const dialogAddCardCardId = document.querySelector("#dialogAddCardCardId");
    const dialogAddCardCardName = document.querySelector(
      "#dialogAddCardCardName"
    );

    dialogAddCardCardName.value =
      dialogAddCardCardId.options[
        dialogAddCardCardId.selectedIndex
      ].dataset.name;
  }

  async function loadListCardDialog(listId, cardId, cardName, lang) {
    console.log(dialogAddCard, dialogDivAddCard);

    console.log("LOADING FORM");

    // if (!cardsDiv || !loading) return;

    // loading.classList.remove("hidden");
    dialogDivAddCard.classList.add("hidden");

    try {
      const response = await fetch(
        `/partials/ListCardFormPartial?list=${listId}&card=${cardId}&cardName=${cardName}&lang=${lang}`
      );
      dialogDivAddCard.innerHTML = await response.text();
    } catch (error) {
      console.error("Failed to load cards:", error);
    } finally {
      // loading.classList.add("hidden");
      dialogDivAddCard.classList.remove("hidden");
    }
  }

  function handleListCardDialogSubmit(event) {
    event.preventDefault();
    console.log("Submit");

    const dialogAddCardListId = document.querySelector("#dialogAddCardListId");
    const dialogAddCardLang = document.querySelector("#dialogAddCardLang");
    const dialogAddCardSetId = document.querySelector("#dialogAddCardSetId");
    const dialogAddCardCardId = document.querySelector("#dialogAddCardCardId");
    const dialogAddCardCardName = document.querySelector(
      "#dialogAddCardCardName"
    );

    console.log(
      dialogAddCardListId,
      dialogAddCardLang,
      dialogAddCardSetId,
      dialogAddCardCardId,
      dialogAddCardCardName
    );

    const listId = dialogAddCardListId.value;
    const setId = dialogAddCardSetId.value;
    const cardId = dialogAddCardCardId.value;
    const lang = dialogAddCardLang.value;
    const cardName = dialogAddCardCardName.value;

    console.log("List ID", listId);
    console.log("Set ID", setId);
    console.log("Card ID", cardId);
    console.log("Lang", lang);
    console.log("Card Name", cardName);

    fetch(`/api/list/add-card`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({
        listId: listId,
        setId: setId,
        cardId: cardId,
        cardName: cardName,
        lang: lang,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Data", data);
        if (data.success) {
          // alert("Card added successfully");
          closeListCardDialog();
          loadCards(listId);
        } else {
          alert("Error adding card: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Error adding card:", error);
      });
    return false; // evita que el form intente recargarse solo
  }
</script>

<!-- <script is:inline>
  let dialogAddCard = null;
  let dialogAddCardListId = null;
  let dialogAddCardSetId = null;
  let dialogAddCardCardId = null;

  document.addEventListener("astro:page-load", () => {
    console.log("DOMContentLoaded");

    dialogAddCard = document.querySelector("#dialogAddCard");
    dialogAddCardListId = document.querySelector("#dialogAddCardListId");
    dialogAddCardSetId = document.querySelector("#dialogAddCardSetId");
    dialogAddCardCardId = document.querySelector("#dialogAddCardCardId");
  });

  function openListCardDialog(listId, cardId) {
    dialogAddCardListId.value = listId;
    dialogAddCardCardId.value = cardId;

    if (dialogAddCard) dialogAddCard.showModal();
  }

  function closeListCardDialog() {
    if (dialogAddCard) dialogAddCard.close();
  }

  function loadSelectSets() {
    const langSelect = document.querySelector('select[name="lang"]');
    const currentLang = langSelect ? langSelect.value : "en";

    fetch(`/api/sets?lang=${currentLang}`)
      .then((response) => response.json())
      .then((data) => {
        console.log("DATA", data);
        const sets = data.sets || [];

        if (!dialogAddCardSetId) return;

        dialogAddCardSetId.innerHTML = "";
        sets.forEach((set) => {
          const option = document.createElement("option");
          option.value = set.id;
          option.textContent = `${set.name} (${set.id})`;
          dialogAddCardSetId.appendChild(option);
        });
      })
      .catch((error) => {
        console.error("Error loading sets:", error);
      });
  }

  function loadSelectCards() {
    console.log("LOAD CARDS");
    if (!dialogAddCardSetId) return;

    const setId = dialogAddCardSetId.value;
    console.log("SET ID", setId);

    // Obtener el idioma del select o usar "en" por defecto
    const langSelect = document.querySelector('select[name="lang"]');
    const currentLang = langSelect ? langSelect.value : "en";

    fetch(`/api/cards/set/${setId}?lang=${currentLang}`)
      .then((response) => response.json())
      .then((data) => {
        console.log("DATA", data);
        const cards = data.cards || [];
        if (!dialogAddCardCardId) return;

        dialogAddCardCardId.innerHTML = "";
        cards.forEach((card) => {
          const option = document.createElement("option");
          option.value = card.id;
          option.textContent = card.localId
            ? `${card.localId} - ${card.name} `
            : card.name;
          dialogAddCardCardId.appendChild(option);
        });
      })
      .catch((error) => {
        console.error("Error loading cards:", error);
      });
  }

  function handleSubmit(event) {
    event.preventDefault();
    console.log("Submit");

    const listIdElement = document.getElementById("listId");
    const setIdElement = document.getElementById("setId");
    const cardIdElement = document.getElementById("cardId");
    const langElement = document.getElementById("lang");

    if (!listIdElement || !setIdElement || !cardIdElement || !langElement) {
      return;
    }

    const listId = listIdElement.value;
    const setId = setIdElement.value;
    const cardId = cardIdElement.value;
    const lang = langElement.value;

    console.log("List ID", listId);
    console.log("Set ID", setId);
    console.log("Card ID", cardId);
    console.log("Lang", lang);

    fetch(`/api/list/add-card`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({
        listId: listId,
        setId: setId,
        cardId: cardId,
        lang: lang,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Data", data);
        if (data.success) {
          alert("Card added successfully");
          loadCards(listId);
        } else {
          alert("Error adding card: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Error adding card:", error);
      });
    return false; // evita que el form intente recargarse solo
  }
</script> -->
