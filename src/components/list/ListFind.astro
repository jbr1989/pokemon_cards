---
import ListCardFilter from './ListCardFilter.astro';

import FilterIcon from "@/assets/ui/filter.svg";

interface Props {
  hasFilter: boolean | null;
}

const { hasFilter } = Astro.props;

console.log("HAS FILTER", hasFilter);

---
<form id="searchForm" class="search-box">
    <span id="ListCardFilterResult"></span>
    <input
        type="search"
        id="search-list-grid"
        placeholder="Buscar..."
        name="name"
        oninput="filtering()"
    />
    {hasFilter &&
        <div style="position:relative">
            <FilterIcon
                id="ListCardFilterIcon"
                width="24px"
                height="24px"
                style="cursor:pointer;"
                onclick="this.nextElementSibling.style.display = (this.nextElementSibling.style.display === 'none' ? '': 'none')"
            />
            <ListCardFilter />
        </div>
    }
</form>

<script defer is:inline>

    let listItems = null;
    let searchForm = null;
    let ListCardFilterIcon = null;
    let ListCardFilterResult = null;

    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM listo!");
      listItems = document.querySelectorAll(".cardItem");
      ListCardFilterIcon = document.querySelector("#ListCardFilterIcon");
      ListCardFilterResult = document.querySelector("#ListCardFilterResult");

      searchForm = document.querySelector("#searchForm");
      searchForm.reset();
    });

    function normalize(text) {
      return text
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "");
    }

    function filtering() {
      console.log("FILTERING");

      if (!listItems) return;
      // console.log(listItems);

      const formData = new FormData(searchForm);
      const nameFilter = normalize(formData.get("name") || "");
      const langFilter = formData.get("lang") || "";
      const typeFilter = formData.get("cardVariantType")?.split(",") || [];
      const stampFilter = formData.get("cardVariantStamp")?.split(",") || [];
      const foilFilter = formData.get("cardVariantFoil")?.split(",") || [];
      const haveitFilter = formData.get("haveIt")?.split(",") || "";

      const hasFilters =
        langFilter.length > 0 ||
        typeFilter.length > 0 ||
        stampFilter.length > 0 ||
        foilFilter.length > 0 ||
        haveitFilter.length > 0;

      console.log("FILTERS", {
        name: nameFilter,
        lang: langFilter,
        type: typeFilter,
        stamp: stampFilter,
        foil: foilFilter,
        haveit: haveitFilter,
      });

      // console.log(
      //   "FILTERS ACTIVE",
      //   typeFilter.length > 0 ||
      //     stampFilter.length > 0 ||
      //     foilFilter.length > 0 ||
      //     langFilter.length > 0
      // );

      if (ListCardFilterIcon!==null)
        ListCardFilterIcon.style.fill = hasFilters ? "#10B981" : "currentColor";

      let num = 0;

      listItems.forEach(function (el) {
        el.classList.add("hidden");

        if (nameFilter != "") {
          let title = normalize(el.dataset.title || "");
          if (!normalize(title).includes(nameFilter)) return;
        }

        if (langFilter.length > 0 && el.dataset.lang !== langFilter) return;
        if (typeFilter.length > 0 && !typeFilter.includes(el.dataset.type))
          return;
        if (stampFilter.length > 0 && !stampFilter.includes(el.dataset.stamp))
          return;
        if (foilFilter.length > 0 && !foilFilter.includes(el.dataset.foil))
          return;
        if (
          haveitFilter.length > 0 &&
          !haveitFilter.includes(el.dataset.haveit)
        )
          return;

        num += 1;
        // Use all visible text within the card for matching
        el.classList.remove("hidden");
      });

      ListCardFilterResult.textContent =
        nameFilter != "" || hasFilters ? `${num} results` : ``;
    }


</script>