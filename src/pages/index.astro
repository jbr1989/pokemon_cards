---
import Layout from "../layouts/Layout.astro";
import SetSelector from "../components/SetSelector.astro";
import CardGrid from "../components/card/CardGrid.astro";

import PopularSets from "../components/PopularSets.astro";
import FeaturedCards from "../components/FeaturedCards.astro";

// Fetch all sets
const language = "es";

// Get the selected set from URL params or use the latest set

const selectedSetId = Astro.url.searchParams.get("set") || "base1";
// console.log(selectedSetId);
---

<Layout title="Pokémon TCG Card Browser">
  {/* Popular Sets Section */}
  <section class="py-12 md:py-16">
    <div class="container px-4 md:px-6">
      <div class="flex flex-col items-start gap-4">
        <h2 class="text-2xl font-bold text-white">Popular Sets</h2>
        <p class="text-zinc-400">Browse the most popular Pokémon card sets.</p>
        <PopularSets />
      </div>
    </div>
  </section>

  {/* Featured Cards Section */}
  <section class="py-12 md:py-16 bg-zinc-900/50">
    <div class="container px-4 md:px-6">
      <div class="flex flex-col items-start gap-4">
        <h2 class="text-2xl font-bold text-white">Your Cards</h2>
        <p class="text-zinc-400">Check out these trending Pokémon cards.</p>
        <FeaturedCards />
      </div>
    </div>
  </section>

  <main>
    <SetSelector selectedLanguage={language} selectedSetId={selectedSetId} />
    <div id="loading" class="loading hidden">Loading cards...</div>
    <CardGrid language={language} setId={selectedSetId} />
  </main>
</Layout>

<script>
  const languageSelector = document.querySelector(
    "#language"
  ) as HTMLSelectElement;
  const setSelector = document.querySelector("#set") as HTMLSelectElement;

  const cardsGrid = document.querySelector("#cards-grid");
  const loading = document.querySelector("#loading");

  async function loadCards(language: string, setId: string) {
    if (!cardsGrid || !loading) return;

    loading.classList.remove("hidden");
    cardsGrid.classList.add("hidden");

    try {
      const response = await fetch(
        `/partials/CardGridPartial?language=${language}&set=${setId}`
      );
      cardsGrid.innerHTML = await response.text();
    } catch (error) {
      console.error("Failed to load cards:", error);
    } finally {
      loading.classList.add("hidden");
      cardsGrid.classList.remove("hidden");
    }
  }

  languageSelector?.addEventListener("change", (e) => {
    loadCards(languageSelector?.value, setSelector.value);
  });

  setSelector?.addEventListener("change", (e) => {
    loadCards(languageSelector?.value, setSelector.value);
  });
</script>

<style is:global></style>
